<!--
記事タイトル候補：
よわよわPCでお絵描きAIやるのは諦めろ
よわよわPCでも高解像度でAIに絵を描かせたい！
intel製Macでも高解像度でAIに絵を描かせたい！
-->

# はじめに

最近AIが絵を描いてくれるツール流行っていますよね。  
Stable Diffusionがすごいとかなんとか・・  
無料で使えるサービスもあるのですが（[DreamStudio](https://photoshopbook.com/2022/10/03/dream-studio/), [お絵描きばりぐっどくん](https://page.line.me/877ieiqs)など）、すぐ制限にかかってしまい使えなくなってしまいます。  
  
じゃあローカルで実行できるようにしよう！  
→ ネットの記事を調べる  
→ 大抵がGPUを使う前提の記事  
→ 自分のよわよわPCじゃ使えない😭  
  
ということで困りまして、 **「そもそも本当にGPUありじゃないと使えない？よわよわPCでもいけるんじゃない？」** ということを検証してみようということでこの記事を書くに至りました。

# 記事の対象者
GPUが搭載されていない/機械学習向きでないPCで無料でStable Diffusionを使うことを検討している人。

# 筆者の環境

![筆者の環境](./assets/environment.png '筆者の環境')
（めっちゃスペックが悪いというわけではないのですが機械学習には向いていない・・）


# Stable Diffusionついて
「Stable Diffusion（ステーブル・ディフュージョン）」とは、テキスト入力されたワードや画像から AI が自動で画像を生成する、オープンソースの画像生成 AI サービス。

# ローカルで実行して比較してみた

Stable Diffusionをさまざまな条件でローカルで実行、速度を検証しました。
- txt2img ... テキストから画像を生成する技術


## 1. 公式のStable Diffusionを実行
まずは、試しに公式の Stable Diffusion をインストールして動かしてみます。  
python の実行環境を整え、diffusers というライブラリを利用します。  
以下のようなコードを書きます。

```python
import os
from diffusers import StableDiffusionPipeline

dir_name = "images"
prompt = "Universe of Fire Particles on the Water's Surface art by teamLab"
steps = 50

if not os.path.exists(dir_name):
    os.mkdir(dir_name)

pipe = StableDiffusionPipeline.from_pretrained(
    "CompVis/stable-diffusion-v1-4",
    revision="fp16",
    use_auth_token=os.getenv("SD_TOKEN")
).to("cpu")

file_name = f"{dir_name}/{prompt}-step_{steps}.png"
print(file_name)
image = pipe(prompt, num_inference_steps=steps)["sample"][0]
image.save(file_name)
```

`SD_TOKEN` には [Hugging Fase](https://huggingface.co/) から取得したトークン入れます。  
↓の画像を出力するのに 25分以上かかりました。

![Universe of Fire Particles on the Water's Surface art by teamLab-step_50-25m33s](https://user-images.githubusercontent.com/40657211/196025673-3f2dafc4-123a-4266-9177-1ecb8cd2ff5a.png)


## 2. CPU最適化されたStable Diffusionを実行

###　1. リポジトリをクローン

下記GitHubリポジトリをStableDiffusionをクローン  
https://github.com/bes-dev/stable_diffusion.openvino  


### 2. ステップ数を変えて実行。精度と時間を比較

呪文
```
コマンド
```

ステップ数: 3
作られれた画像  
実行時間  

ステップ数: 5
作られれた画像  
実行時間  

ステップ数: 10
作られれた画像  
実行時間  


結果比較

ついでに同じ条件でGoogle Colabでも実施してみたので結果を載せます。

| ステップ数 | 公式 | OpenVINO | Google Colab | 精度 |
| ---------- | ---------- | ------------ | ------------ | ------------ |
| 3  | 2分      | 27秒    |     | 悪い |
| 5  | 3分      | 39秒    |     | ちょっと悪い |
| 10 | 5分27秒  | 1分19秒  |     | ちょっと良さそう |
| 50 | 25分18秒 | 6分43秒  |     | 良さそう |


<!--
<img src=./assets/txt2image.png  width="200px">

img2img を実行
inpainting を実行
 -->
 
# 所感
openvino を使う：30分→6分
ステップ数を下げる：6分→1分

# おわりに

CPUに最適化されたツールを使えばローカルでもいけなくない。
速度を求めるならおとなしく Google Colab を使おう

# 参考資料
