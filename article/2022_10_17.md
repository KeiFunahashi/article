# ã¯ã˜ã‚ã«

æœ€è¿‘AIãŒçµµã‚’æã„ã¦ãã‚Œã‚‹ãƒ„ãƒ¼ãƒ«æµè¡Œã£ã¦ã„ã¾ã™ã‚ˆã­ã€‚  
Stable DiffusionãŒã™ã”ã„ã¨ã‹ãªã‚“ã¨ã‹ãƒ»ãƒ»  
ç„¡æ–™ã§ä½¿ãˆã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚‚ã‚ã‚‹ã®ã§ã™ãŒï¼ˆ[DreamStudio](https://photoshopbook.com/2022/10/03/dream-studio/), [ãŠçµµæãã°ã‚Šãã£ã©ãã‚“](https://page.line.me/877ieiqs)ãªã©ï¼‰ã€ã™ãåˆ¶é™ã«ã‹ã‹ã£ã¦ã—ã¾ã„ä½¿ãˆãªããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚  
  
ã˜ã‚ƒã‚ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã—ã‚ˆã†ï¼  
ã£ã¦ã“ã¨ã§ </br>
â†’ ãƒãƒƒãƒˆã®è¨˜äº‹ã‚’èª¿ã¹ã¦ã¿ã‚‹ </br>
â†’ å¤§æŠµãŒGPUã‚’ä½¿ã†å‰æã®è¨˜äº‹ </br>
â†’ è‡ªåˆ†ã®ã‚ˆã‚ã‚ˆã‚ intel CPU ã˜ã‚ƒä½¿ãˆãªã„ã®ã‹..ğŸ˜­ </br>
â†’ **ã€Œã‚“?ãã‚‚ãã‚‚æœ¬å½“ã«GPUã‚ã‚Šã˜ã‚ƒãªã„ã¨ä½¿ãˆãªã„ã®ã‹ï¼Ÿã‚ˆã‚ã‚ˆã‚PCã§ã‚‚ã„ã‘ã‚‹ã‚“ã˜ã‚ƒãªã„ï¼Ÿã€**  </br>
ã¨ã„ã†ã“ã¨ã‚’æ¤œè¨¼ã—ã¦ã¿ã‚ˆã†ã¨ã€ã“ã®è¨˜äº‹ã‚’æ›¸ãã«è‡³ã‚Šã¾ã—ãŸã€‚

# è¨˜äº‹ã®å¯¾è±¡è€…
GPUãŒæ­è¼‰ã•ã‚Œã¦ã„ãªã„/æ©Ÿæ¢°å­¦ç¿’å‘ãã§ãªã„PCã§ç„¡æ–™ã§Stable Diffusionã‚’ä½¿ã†ã“ã¨ã‚’æ¤œè¨ã—ã¦ã„ã‚‹äººã€‚

# ç­†è€…ã®ç’°å¢ƒ

<img width="513" alt="ç’°å¢ƒ" src="https://user-images.githubusercontent.com/59855529/196094272-fd9ff9d3-ebf7-463d-b905-1693c9562412.png">

# Stable Diffusionã¤ã„ã¦
Stable Diffusionã¨ã¯ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«æ²¿ã£ã¦äººé–“ãŒæã„ãŸã‚ˆã†ãªç”»åƒã‚’ç”Ÿã¿å‡ºã™AIã®ã“ã¨ã§ã™ã€‚  
Stable Diffusionã‚’ç”¨ã„ãŸæŠ€è¡“ã¨ã—ã¦ã¯ä¸‹è¨˜ã®ã‚ˆã†ãªã‚‚ã®ãŒã‚ã‚Šã¾ã™ã€‚  
- txt2img(text to image) ... ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ç”»åƒã‚’ç”Ÿæˆ
- img2img(image to image) ... ãƒ†ã‚­ã‚¹ãƒˆã¨ç”»åƒã‹ã‚‰æ–°ãŸãªç”»åƒã‚’ç”Ÿæˆ
- inpainting ... æŒ‡å®šç¯„å›²ã‚’ãƒ†ã‚­ã‚¹ãƒˆã§æŒ‡ç¤ºã—ã¦ç”»åƒä¿®å¾©


# æ§˜ã€…ãªç’°å¢ƒã§å®Ÿè¡Œã—ã¦æ¯”è¼ƒã—ã¦ã¿ãŸ
ä»Šå›ã¯ç‰¹ã« txt2img ã«çµã£ã¦ã€æ§˜ã€…ãªç’°å¢ƒã§é€Ÿåº¦ã‚„å®Œæˆåº¦ã‚’æ¯”è¼ƒã—ã¦ã¿ã¾ã—ãŸã€‚
1. å…¬å¼ã®Stable Diffusionã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œ
2. CPUæœ€é©åŒ–ã•ã‚ŒãŸStable Diffusionã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œ
3. å…¬å¼ã®Stable Diffusionã‚’Google Colab (ç„¡æ–™)ä¸Šã§å®Ÿè¡Œ

txt2imgã«æ¸¡ã™ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå‘ªæ–‡ï¼‰ã¯ä¸‹è¨˜ã€‚
ãƒãƒ¼ãƒ ãƒ©ãƒœãƒ—ãƒ©ãƒãƒƒãƒ„ã®ä½œå“åã‚’ãã®ã¾ã¾ä½¿ã£ã¦ã¿ã¾ã—ãŸã€‚
https://planets.teamlab.art/tokyo/jp/ew/universe_fireparticles/
```
Universe of Fire Particles on the Waterâ€™s Surface art by teamLab
```
ã‚¹ãƒ†ãƒƒãƒ—æ•°ã¯ 3, 5, 10, 50 ã®4ã¤ã§è©¦ã—ã¾ã—ãŸã€‚
ã‚¹ãƒ†ãƒƒãƒ—æ•°ãŒå¤šã„æ–¹ãŒç²¾åº¦ã¯é«˜ããªã‚Šã¾ã™ãŒã€ãã®åˆ†æ™‚é–“ã¯ã‹ã‹ã‚Šã¾ã™ã€‚


## 1. ãƒ­ãƒ¼ã‚«ãƒ«ã§å…¬å¼ã®Stable Diffusionã‚’å®Ÿè¡Œ
ã¾ãšã¯ã€è©¦ã—ã«å…¬å¼ã® Stable Diffusion ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦å‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚  
python ã®å®Ÿè¡Œç’°å¢ƒã‚’æ•´ãˆã€diffusers ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã—ã¾ã™ã€‚  
ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¾ã™ã€‚

```python
import os
from diffusers import StableDiffusionPipeline

dir_name = "images"
prompt = "Universe of Fire Particles on the Water's Surface art by teamLab"
steps = 50

if not os.path.exists(dir_name):
    os.mkdir(dir_name)

pipe = StableDiffusionPipeline.from_pretrained(
    "CompVis/stable-diffusion-v1-4",
    revision="fp16",
    use_auth_token=os.getenv("SD_TOKEN")
).to("cpu")

file_name = f"{dir_name}/{prompt}-step_{steps}.png"
print(file_name)
image = pipe(prompt, num_inference_steps=steps)["sample"][0]
image.save(file_name)
```

`SD_TOKEN` ã«ã¯ [Hugging Fase](https://huggingface.co/) ã‹ã‚‰å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³å…¥ã‚Œã¾ã™ã€‚  
â†“ã®ç”»åƒã‚’å‡ºåŠ›ã™ã‚‹ã®ã« 25åˆ†ä»¥ä¸Šã‹ã‹ã‚Šã¾ã—ãŸã€‚

![Universe of Fire Particles on the Water's Surface art by teamLab-step_50-25m33s](https://user-images.githubusercontent.com/40657211/196025673-3f2dafc4-123a-4266-9177-1ecb8cd2ff5a.png)

ç”Ÿæˆã•ã‚ŒãŸç”»åƒã«ã¤ã„ã¦è¡¨ã«ã¾ã¨ã‚ã¾ã™ã€‚ç”»åƒã¯ç¸®å°ã—ã¦ã„ã¾ã™ã€‚
ã‚¹ãƒ†ãƒƒãƒ—æ•°5ã¯NSFWãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«å¼•ã£ã‹ã‹ã£ã¦ã—ã¾ã£ãŸã‚ˆã†ã§ã™ã€‚ã€‚
| ã‚¹ãƒ†ãƒƒãƒ—æ•° | ç”»åƒ |
| ---------- | ---------- |
| 3  | <img width="200" alt="generated" src="https://user-images.githubusercontent.com/59855529/196084071-17e0bf32-dfc1-49af-b29d-40d8021384cc.png"> |
| 5  | <img width="200" alt="generated" src="https://user-images.githubusercontent.com/59855529/196083861-df603753-7026-40cb-93cb-9b65cccd2656.png"> |
| 10 | <img width="200" alt="generated" src="https://user-images.githubusercontent.com/59855529/196083954-52852a25-edfa-4680-9984-4ad473921ab5.png"> |
| 50 | <img width="200" alt="generated" src="https://user-images.githubusercontent.com/59855529/196083866-95bed627-96b2-422e-8298-f2e87f36b675.png"> |

## 2. CPUæœ€é©åŒ–ã•ã‚ŒãŸStable Diffusionã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œ

ä¸‹è¨˜ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½¿ã£ã¦é€²ã‚ã¦ã„ãã¾ã™ã€‚
OpenVINOã‚’ä½¿ã£ã¦ãŠã‚Šã€Intel CPUã§ã‚‚Stable DiffusionãŒè¡Œãˆã‚‹ã‚ˆã†æœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://github.com/bes-dev/stable_diffusion.openvino  

###ã€€1. ç’°å¢ƒæ§‹ç¯‰


1. Python 3.8 ä»¥ä¸Šã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠã
2. ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ç’°å¢ƒæ§‹ç¯‰
```
git clone git@github.com:bes-dev/stable_diffusion.openvino.git
cd stable_diffusion.openvino
python3 -m venv venv
source venv/bin/activate
pip3 install -r requirements.txt
```

### 2. ã‚¹ãƒ†ãƒƒãƒ—æ•°ã‚’å¤‰ãˆã¦å®Ÿè¡Œ

å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ï¼š
```
python3 demo.py --prompt "Universe of Fire Particles on the Waterâ€™s Surface art by teamLab" --num-inference-steps 10
```
ä¸Šè¨˜ã®`--num-inference-steps`ã§ã‚¹ãƒ†ãƒƒãƒ—æ•°ã‚’èª¿æ•´ã—ã¾ã™ã€‚


å„ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ç”Ÿæˆã•ã‚ŒãŸç”»åƒã¯ä¸‹è¨˜ã€‚ç”»åƒã¯ç¸®å°ã—ã¦ã„ã¾ã™ã€‚

| ã‚¹ãƒ†ãƒƒãƒ—æ•° | ç”»åƒ |
| ---------- | ---------- |
| 3  | <img width="200" alt="generated" src="https://user-images.githubusercontent.com/59855529/196084842-562da720-a3c7-475c-a210-ec89d04f3043.png"> |
| 5  | <img width="200" alt="generated" src="https://user-images.githubusercontent.com/59855529/196084849-de57b373-3524-40ab-a83d-e59797a1671d.png"> |
| 10 | <img width="200" alt="generated" src="https://user-images.githubusercontent.com/59855529/196084852-ffd4b00a-7588-4ed0-86f4-24f6189c83fa.png"> |
| 50 | <img width="200" alt="generated" src="https://user-images.githubusercontent.com/59855529/196084853-fe9b112a-d5a4-476c-b399-4a1b12978f31.png"> |

## 3. å…¬å¼ã®Stable Diffusionã‚’Google Colab (ç„¡æ–™)ä¸Šã§å®Ÿè¡Œ

ä¸‹è¨˜ã‚’Colabãƒãƒ¼ãƒˆã«æ›¸ã„ã¦ã„ãã¾ã™ã€‚
### 1. äº‹å‰æº–å‚™

TOKEN ã«ã¯Hugging Faceã§ç™ºè¡Œã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```
4!pip install transformers scipy ftfy diffusers

import os
import shutil
import torch
from torch import autocast
from google.colab import files
from diffusers import StableDiffusionPipeline

TOKEN = "{{Hugging Faceã§ç™ºè¡Œã—ãŸãƒˆãƒ¼ã‚¯ãƒ³}}"

pipe = StableDiffusionPipeline.from_pretrained(
    "CompVis/stable-diffusion-v1-4",
    revision="fp16", 
    torch_dtype=torch.float16,
    use_auth_token=TOKEN
).to("cuda")
```

### 2. å®Ÿè¡Œ
`prompt` ã«å‘ªæ–‡ã‚’æŒ‡å®šã—ã¾ã™ã€‚
`steps` ã«ã‚¹ãƒ†ãƒƒãƒ—æ•°ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```
import time

dir_name = "images"
prompt = "Waterfall of Light Particles at the Top of an Incline art by teamLab"

os.mkdir(dir_name)

steps = 3
os.mkdir(f"{dir_name}/{steps}steps")
for i in range(5):
    print("i: ", end="")
    with autocast("cuda"):
        time_sta = time.time()
        image = pipe(prompt, guidance_scale=7.5, num_inference_steps=steps)["sample"][0]
        elapsed = round(time.time() - time_sta, 1)
        image.save(f"{dir_name}/{steps}steps/{i}it_{elapsed}seconds.png")
        print(elapsed)

os.system(f"zip -r {dir_name}.zip {dir_name}")
files.download(f"{dir_name}.zip")
```

### 3. å¾Œå‡¦ç†
ç”Ÿæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—çµ‚ãˆãŸã‚‰å‰Šé™¤ã—ã¾ã™ã€‚
```
shutil.rmtree(dir_name)
os.remove(f"{dir_name}.zip")
```


å„ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ç”Ÿæˆã•ã‚ŒãŸç”»åƒã¯ä¸‹è¨˜ã€‚ç”»åƒã¯ç¸®å°ã—ã¦ã„ã¾ã™ã€‚

| ã‚¹ãƒ†ãƒƒãƒ—æ•° | ç”»åƒ |
| ---------- | ---------- |
| 3  | <img width="200" alt="generated" src="https://user-images.githubusercontent.com/59855529/196085237-8947cfbf-838b-44d1-8068-69ff27ac741d.png"> |
| 5  | <img width="200" alt="generated" src="https://user-images.githubusercontent.com/59855529/196085241-893cece2-f7d9-47f6-9e4f-d5f149286102.png"> |
| 10 | <img width="200" alt="generated" src="https://user-images.githubusercontent.com/59855529/196085244-6d6b2d8c-9e2a-45e0-b067-b055cd40aa30.png"> |
| 50 | <img width="200" alt="generated" src="https://user-images.githubusercontent.com/59855529/196085246-23acf4d1-db10-47c2-86ea-0b302e8dc8bb.png"> |


## çµæœæ¯”è¼ƒ

| ã‚¹ãƒ†ãƒƒãƒ—æ•° | å…¬å¼ | OpenVINO | Google Colab | ç²¾åº¦ |
| ---------- | ---------- | ------------ | ------------ | ------------ |
| 3  | 2åˆ†      | 27ç§’    | 1.6ç§’ | æŠ½è±¡ç”»ã®ã‚ˆã†ã«ãªã‚‹ |
| 5  | 3åˆ†      | 39ç§’    | 2.2ç§’ | ã‚¹ãƒ†ãƒƒãƒ—æ•°3è¿‘ã„ |
| 10 | 5åˆ†27ç§’  | 1åˆ†19ç§’  | 3.8ç§’ | æ¯”è¼ƒçš„ãƒªã‚¢ãƒ«ã«ãªã£ãŸ |
| 50 | 25åˆ†18ç§’ | 6åˆ†43ç§’  | 15.6ç§’ | ã‚¹ãƒ†ãƒƒãƒ—æ•°10ã‚ˆã‚Šã•ã‚‰ã«ãƒªã‚¢ãƒ«ã«ãªã£ãŸ |
 
 
# æ‰€æ„Ÿ
openvino ã‚’ä½¿ã†ï¼š30åˆ†â†’6åˆ†
ã‚¹ãƒ†ãƒƒãƒ—æ•°ã‚’ä¸‹ã’ã‚‹ï¼š6åˆ†â†’1åˆ†

CPUã«æœ€é©åŒ–ã•ã‚ŒãŸãƒ„ãƒ¼ãƒ«ã‚’ä½¿ãˆã°ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚‚ã„ã‘ãªããªã„ã€‚
é€Ÿåº¦ã‚’æ±‚ã‚ã‚‹ãªã‚‰ãŠã¨ãªã—ã Google Colab ã‚’ä½¿ãŠã†

# å‚è€ƒè³‡æ–™
